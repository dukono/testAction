name: "07 - Manejo de Secretos y Seguridad"

# Demuestra manejo seguro de secretos, variables de entorno y seguridad
# IMPORTANTE: Nunca exponer secretos en logs

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno'
        type: choice
        options:
          - dev
          - staging
          - production
        default: dev

# Variables a nivel de workflow
env:
  APP_NAME: "SecureApp"
  PUBLIC_API_URL: "https://api.example.com"

jobs:
  # ============================================================================
  # JOB 1: JERARQUÃA DE VARIABLES Y SECRETOS
  # ============================================================================
  variable-hierarchy:
    name: "JerarquÃ­a de Variables"
    runs-on: ubuntu-latest
    env:
      # Variables a nivel de job
      JOB_VAR: "job-level"
      OVERRIDE_TEST: "from-job"
    
    steps:
      - name: "Variables a nivel de workflow"
        run: |
          echo "ðŸ“‹ Variables de Workflow:"
          echo "  APP_NAME: $APP_NAME"
          echo "  PUBLIC_API_URL: $PUBLIC_API_URL"
      
      - name: "Variables a nivel de job"
        run: |
          echo "ðŸ“‹ Variables de Job:"
          echo "  JOB_VAR: $JOB_VAR"
          echo "  OVERRIDE_TEST: $OVERRIDE_TEST"
      
      - name: "Variables a nivel de step (override)"
        env:
          STEP_VAR: "step-level"
          OVERRIDE_TEST: "from-step"
        run: |
          echo "ðŸ“‹ Variables de Step:"
          echo "  STEP_VAR: $STEP_VAR"
          echo "  OVERRIDE_TEST: $OVERRIDE_TEST (sobrescribe job)"
      
      - name: "Variables desde secrets"
        env:
          GITHUB_TOKEN_PRESENT: ${{ secrets.GITHUB_TOKEN != '' }}
        run: |
          echo "ðŸ“‹ Secretos:"
          echo "  GITHUB_TOKEN presente: $GITHUB_TOKEN_PRESENT"
      
      - name: "Variables desde inputs"
        run: |
          echo "ðŸ“‹ Inputs del Workflow:"
          echo "  environment: ${{ inputs.environment }}"
      
      - name: "Variables desde contexts"
        run: |
          echo "ðŸ“‹ Contexts de GitHub:"
          echo "  Repositorio: ${{ github.repository }}"
          echo "  Actor: ${{ github.actor }}"
          echo "  SHA: ${{ github.sha }}"
          echo "  Ref: ${{ github.ref }}"
          echo "  Run ID: ${{ github.run_id }}"

  # ============================================================================
  # JOB 2: MANEJO SEGURO DE SECRETOS
  # ============================================================================
  secure-secrets:
    name: "Manejo Seguro de Secretos"
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
      
      - name: "Usar secretos correctamente"
        env:
          API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âœ… Secretos cargados en variables de entorno"
          echo "âœ… Secretos usados de forma segura"
      
      - name: "Crear archivo de configuraciÃ³n con secreto"
        env:
          API_KEY: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CONFIG_FILE=$(mktemp)
          
          cat > "$CONFIG_FILE" << EOF
          api:
            key: $API_KEY
          EOF
          
          echo "âœ… Archivo de configuraciÃ³n creado: $CONFIG_FILE"
          rm -f "$CONFIG_FILE"
          echo "ðŸ—‘ï¸ Archivo temporal eliminado"
      
      - name: "âš ï¸ Ejemplos de malas prÃ¡cticas (comentados)"
        run: |
          cat << 'EOF'
          âŒ NO HACER ESTO:
          
          1. âŒ echo "Token: ${{ secrets.TOKEN }}"
          2. âŒ echo "${{ secrets.PASSWORD }}" > file.txt
          3. âŒ git commit -m "Add token ${{ secrets.TOKEN }}"
          
          âœ… EN SU LUGAR:
          
          1. âœ… env:
                TOKEN: ${{ secrets.TOKEN }}
          2. âœ… Usar archivos temporales con permisos restringidos
          3. âœ… Nunca commitear secretos
          EOF
      
      - name: "Validar secretos requeridos"
        run: |
          MISSING_SECRETS=()
          
          if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then
            MISSING_SECRETS+=("GITHUB_TOKEN")
          fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ Faltan secretos: ${MISSING_SECRETS[@]}"
            exit 1
          fi
          
          echo "âœ… Todos los secretos necesarios estÃ¡n configurados"
      
      - name: "Enmascarar valores personalizados"
        run: |
          GENERATED_TOKEN="super-secret-$(date +%s)"
          echo "::add-mask::$GENERATED_TOKEN"
          echo "Token generado (enmascarado)"
          echo "Token: $GENERATED_TOKEN"

  # ============================================================================
  # JOB 3: VARIABLES POR ENTORNO
  # ============================================================================
  environment-variables:
    name: "Variables por Entorno"
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: "ConfiguraciÃ³n por entorno"
        run: |
          echo "ðŸŒ Entorno: ${{ inputs.environment }}"
      
      - name: "LÃ³gica condicional por entorno"
        run: |
          case "${{ inputs.environment }}" in
            dev)
              echo "ðŸ”§ ConfiguraciÃ³n de DESARROLLO"
              DEBUG_MODE=true
              LOG_LEVEL=debug
              REPLICAS=1
              ;;
            staging)
              echo "ðŸ§ª ConfiguraciÃ³n de STAGING"
              DEBUG_MODE=false
              LOG_LEVEL=info
              REPLICAS=2
              ;;
            production)
              echo "ðŸš€ ConfiguraciÃ³n de PRODUCCIÃ“N"
              DEBUG_MODE=false
              LOG_LEVEL=warn
              REPLICAS=5
              ;;
          esac
          
          echo "DEBUG_MODE=$DEBUG_MODE" >> $GITHUB_ENV
          echo "LOG_LEVEL=$LOG_LEVEL" >> $GITHUB_ENV
          echo "REPLICAS=$REPLICAS" >> $GITHUB_ENV
      
      - name: "Usar configuraciÃ³n del entorno"
        run: |
          echo "âš™ï¸ ConfiguraciÃ³n aplicada:"
          echo "  Debug: $DEBUG_MODE"
          echo "  Log Level: $LOG_LEVEL"
          echo "  RÃ©plicas: $REPLICAS"

  # ============================================================================
  # JOB 4: REPORTE FINAL
  # ============================================================================
  report:
    name: "Reporte Final"
    runs-on: ubuntu-latest
    needs: [variable-hierarchy, secure-secrets, environment-variables]
    if: always()
    
    steps:
      - name: "Generar reporte"
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ“‹ Reporte de ConfiguraciÃ³n y Seguridad
          
          ## ðŸ”§ Variables de Entorno
          - **Workflow level:** Variables compartidas por todos los jobs
          - **Job level:** Variables especÃ­ficas del job
          - **Step level:** Variables que sobrescriben las anteriores
          
          ## ðŸ” Secretos
          - **Repository secrets:** Disponibles en todos los workflows
          - **Environment secrets:** EspecÃ­ficos del environment
          
          ## ðŸŒ Entorno Seleccionado
          `${{ inputs.environment }}`
          
          ## âœ… Estado de Jobs
          - **Variable Hierarchy:** ${{ needs.variable-hierarchy.result }}
          - **Secure Secrets:** ${{ needs.secure-secrets.result }}
          - **Environment Variables:** ${{ needs.environment-variables.result }}
          EOF
