name: "ðŸŽ¯ DEMO COMPLETA - Todas las Capacidades"

# Este workflow demuestra TODAS las capacidades en un solo ejemplo ejecutable
# Es una demostraciÃ³n interactiva de todo el poder de GitHub Actions

on:
  workflow_dispatch:
    inputs:
      demo-mode:
        description: 'ðŸŽ® Modo de demostraciÃ³n'
        required: true
        type: choice
        options:
          - quick      # Demo rÃ¡pida (5 min)
          - standard   # Demo estÃ¡ndar (15 min)
          - complete   # Demo completa (30 min)
        default: standard
      
      enable-cache:
        description: 'ðŸ’¾ Usar cache'
        type: boolean
        default: true
      
      enable-matrix:
        description: 'ðŸ“Š Usar matrices'
        type: boolean
        default: true
      
      deploy-target:
        description: 'ðŸš€ Desplegar a'
        type: choice
        options:
          - none
          - dev
          - staging
        default: dev

env:
  DEMO_VERSION: "2024.1.0"
  PROJECT_NAME: "GitHubActionsDemo"

# Permisos explÃ­citos (seguridad)
permissions:
  contents: read
  packages: write
  issues: write

jobs:
  # ============================================================================
  # ðŸ“‹ JOB 1: ORQUESTADOR - Planifica toda la ejecuciÃ³n
  # ============================================================================
  orchestrator:
    name: "ðŸŽ¯ Orquestador de Demo"
    runs-on: ubuntu-latest
    outputs:
      # Outputs para controlar flujo
      run-tests: ${{ steps.plan.outputs.run-tests }}
      run-build: ${{ steps.plan.outputs.run-build }}
      run-deploy: ${{ steps.plan.outputs.run-deploy }}
      test-matrix: ${{ steps.plan.outputs.test-matrix }}
      os-matrix: ${{ steps.plan.outputs.os-matrix }}
      deploy-config: ${{ steps.plan.outputs.deploy-config }}
      execution-id: ${{ steps.plan.outputs.execution-id }}
    
    steps:
      - name: "ðŸŽ¬ Inicio de Demo"
        run: |
          cat << 'EOF'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                                                               â•‘
          â•‘   ðŸŽ¯ DEMO COMPLETA DE GITHUB ACTIONS                         â•‘
          â•‘                                                               â•‘
          â•‘   Esta es una demostraciÃ³n interactiva de TODAS              â•‘
          â•‘   las capacidades avanzadas de GitHub Actions                â•‘
          â•‘                                                               â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
      
      - name: "ðŸ“Š Planificar ejecuciÃ³n"
        id: plan
        run: |
          EXEC_ID="demo-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "execution-id=$EXEC_ID" >> $GITHUB_OUTPUT
          
          # Planificar segÃºn modo
          case "${{ inputs.demo-mode }}" in
            quick)
              echo "âš¡ Modo RÃPIDO"
              echo "run-tests=true" >> $GITHUB_OUTPUT
              echo "run-build=true" >> $GITHUB_OUTPUT
              echo "run-deploy=false" >> $GITHUB_OUTPUT
              echo 'test-matrix=["unit"]' >> $GITHUB_OUTPUT
              echo 'os-matrix=["ubuntu-latest"]' >> $GITHUB_OUTPUT
              ;;
            standard)
              echo "ðŸ“‹ Modo ESTÃNDAR"
              echo "run-tests=true" >> $GITHUB_OUTPUT
              echo "run-build=true" >> $GITHUB_OUTPUT
              echo "run-deploy=${{ inputs.deploy-target != 'none' }}" >> $GITHUB_OUTPUT
              echo 'test-matrix=["unit","integration"]' >> $GITHUB_OUTPUT
              echo 'os-matrix=["ubuntu-latest","windows-latest"]' >> $GITHUB_OUTPUT
              ;;
            complete)
              echo "ðŸŽ¯ Modo COMPLETO"
              echo "run-tests=true" >> $GITHUB_OUTPUT
              echo "run-build=true" >> $GITHUB_OUTPUT
              echo "run-deploy=${{ inputs.deploy-target != 'none' }}" >> $GITHUB_OUTPUT
              echo 'test-matrix=["unit","integration","e2e"]' >> $GITHUB_OUTPUT
              echo 'os-matrix=["ubuntu-latest","windows-latest","macos-latest"]' >> $GITHUB_OUTPUT
              ;;
          esac
          
          # ConfiguraciÃ³n de deploy
          DEPLOY_CONFIG=$(cat << EOFJSON
          {
            "target": "${{ inputs.deploy-target }}",
            "version": "${{ env.DEMO_VERSION }}",
            "execId": "$EXEC_ID",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOFJSON
          )
          
          echo "deploy-config=$(echo $DEPLOY_CONFIG | jq -c .)" >> $GITHUB_OUTPUT
      
      - name: "ðŸ“„ Generar plan de ejecuciÃ³n"
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸŽ¯ Plan de EjecuciÃ³n
          
          ## âš™ï¸ ConfiguraciÃ³n
          - **Modo:** `${{ inputs.demo-mode }}`
          - **Cache:** ${{ inputs.enable-cache && 'âœ…' || 'âŒ' }}
          - **Matrices:** ${{ inputs.enable-matrix && 'âœ…' || 'âŒ' }}
          - **Deploy:** `${{ inputs.deploy-target }}`
          - **Execution ID:** `${{ steps.plan.outputs.execution-id }}`
          
          ## ðŸ“‹ Jobs a Ejecutar
          - **Tests:** ${{ steps.plan.outputs.run-tests == 'true' && 'âœ…' || 'â­ï¸' }}
          - **Build:** ${{ steps.plan.outputs.run-build == 'true' && 'âœ…' || 'â­ï¸' }}
          - **Deploy:** ${{ steps.plan.outputs.run-deploy == 'true' && 'âœ…' || 'â­ï¸' }}
          
          ## ðŸ“Š Matrices
          - **Test types:** ${{ steps.plan.outputs.test-matrix }}
          - **OS:** ${{ steps.plan.outputs.os-matrix }}
          
          ---
          ðŸš€ **Iniciando ejecuciÃ³n...**
          EOF

  # ============================================================================
  # ðŸ§ª JOB 2: TESTS CON MATRIZ DINÃMICA
  # ============================================================================
  tests:
    name: "ðŸ§ª Tests: ${{ matrix.type }} on ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    needs: orchestrator
    if: needs.orchestrator.outputs.run-tests == 'true' && inputs.enable-matrix
    
    strategy:
      fail-fast: false
      matrix:
        type: ${{ fromJSON(needs.orchestrator.outputs.test-matrix) }}
        os: ${{ fromJSON(needs.orchestrator.outputs.os-matrix) }}
    
    outputs:
      test-results: ${{ steps.test.outputs.results }}
    
    steps:
      - name: "ðŸ“¥ Checkout"
        uses: actions/checkout@v4
      
      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: ${{ inputs.enable-cache && 'pip' || '' }}
      
      - name: "ðŸ“¦ Cache de dependencias (manual)"
        if: inputs.enable-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache
            .pytest_cache
          key: test-${{ matrix.os }}-${{ matrix.type }}-${{ hashFiles('**/*.py') }}
          restore-keys: |
            test-${{ matrix.os }}-${{ matrix.type }}-
            test-${{ matrix.os }}-
      
      - name: "ðŸ”§ Instalar dependencias"
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          echo "âœ… Dependencias instaladas"
      
      - name: "ðŸ§ª Ejecutar tests ${{ matrix.type }}"
        id: test
        run: |
          echo "Ejecutando tests: ${{ matrix.type }}"
          
          # Simular tests con diferentes duraciones
          case "${{ matrix.type }}" in
            unit)
              DURATION=3
              TOTAL=50
              PASSED=49
              ;;
            integration)
              DURATION=8
              TOTAL=25
              PASSED=24
              ;;
            e2e)
              DURATION=15
              TOTAL=10
              PASSED=10
              ;;
          esac
          
          for i in $(seq 1 $DURATION); do
            echo "  Progreso: $((i * 100 / DURATION))%"
            sleep 1
          done
          
          RESULTS=$(cat << EOFJSON
          {
            "type": "${{ matrix.type }}",
            "os": "${{ matrix.os }}",
            "total": $TOTAL,
            "passed": $PASSED,
            "failed": $((TOTAL - PASSED))
          }
          EOFJSON
          )
          
          echo "results=$(echo $RESULTS | jq -c .)" >> $GITHUB_OUTPUT
          echo "âœ… Tests completados: $PASSED/$TOTAL"
      
      - name: "ðŸ“Š Subir resultados"
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.type }}-${{ matrix.os }}
          path: |
            test-results.json
          retention-days: 7

  # ============================================================================
  # ðŸ—ï¸ JOB 3: BUILD CON CACHE Y ARTIFACTS
  # ============================================================================
  build:
    name: "ðŸ—ï¸ Build de AplicaciÃ³n"
    runs-on: ubuntu-latest
    needs: [orchestrator, tests]
    if: |
      always() &&
      needs.orchestrator.outputs.run-build == 'true' &&
      (needs.tests.result == 'success' || needs.tests.result == 'skipped')
    
    outputs:
      artifact-name: ${{ steps.build.outputs.artifact-name }}
      build-sha: ${{ steps.build.outputs.sha }}
    
    steps:
      - name: "ðŸ“¥ Checkout"
        uses: actions/checkout@v4
      
      - name: "ðŸ’¾ Cache de build"
        if: inputs.enable-cache
        id: cache-build
        uses: actions/cache@v4
        with:
          path: |
            dist/
            build/
          key: build-${{ github.sha }}
          restore-keys: |
            build-
      
      - name: "ðŸ—ï¸ Build (o usar cache)"
        id: build
        if: steps.cache-build.outputs.cache-hit != 'true'
        run: |
          echo "ðŸ”¨ Compilando aplicaciÃ³n..."
          
          mkdir -p dist
          
          # Simular build
          cat > dist/app.js << 'EOFAPP'
          console.log("${{ env.PROJECT_NAME }} v${{ env.DEMO_VERSION }}");
          console.log("Build: ${{ needs.orchestrator.outputs.execution-id }}");
          console.log("Commit: ${{ github.sha }}");
          EOFAPP
          
          # Metadata
          cat > dist/manifest.json << EOFMANIFEST
          {
            "name": "${{ env.PROJECT_NAME }}",
            "version": "${{ env.DEMO_VERSION }}",
            "buildId": "${{ needs.orchestrator.outputs.execution-id }}",
            "commit": "${{ github.sha }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "actor": "${{ github.actor }}"
          }
          EOFMANIFEST
          
          # Generar checksum
          BUILD_SHA=$(find dist -type f -exec sha256sum {} \; | sha256sum | cut -d' ' -f1)
          
          ARTIFACT_NAME="build-${{ env.DEMO_VERSION }}-${{ github.run_number }}"
          
          echo "artifact-name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "sha=$BUILD_SHA" >> $GITHUB_OUTPUT
          
          sleep 3
          echo "âœ… Build completado"
      
      - name: "âš¡ Usar build cacheado"
        if: steps.cache-build.outputs.cache-hit == 'true'
        run: |
          echo "âš¡ Build recuperado desde cache"
          cat dist/manifest.json | jq .
          
          BUILD_SHA=$(find dist -type f -exec sha256sum {} \; | sha256sum | cut -d' ' -f1)
          ARTIFACT_NAME="build-${{ env.DEMO_VERSION }}-${{ github.run_number }}"
          
          echo "artifact-name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "sha=$BUILD_SHA" >> $GITHUB_OUTPUT
      
      - name: "ðŸ“¦ Subir artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact-name }}
          path: dist/
          retention-days: 30
      
      - name: "ðŸ“Š Resumen de build"
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ—ï¸ Build Completado
          
          - **Artifact:** \`${{ steps.build.outputs.artifact-name }}\`
          - **SHA256:** \`${{ steps.build.outputs.sha }}\`
          - **Cache usado:** ${{ steps.cache-build.outputs.cache-hit == 'true' && 'âœ… SÃ­' || 'âŒ No' }}
          - **TamaÃ±o:** $(du -sh dist | cut -f1)
          
          ## ðŸ“„ Manifest
          \`\`\`json
          $(cat dist/manifest.json | jq .)
          \`\`\`
          EOF

  # ============================================================================
  # ðŸš€ JOB 4: DEPLOY USANDO WORKFLOW REUSABLE (si existe)
  # ============================================================================
  deploy:
    name: "ðŸš€ Deploy a ${{ inputs.deploy-target }}"
    runs-on: ubuntu-latest
    needs: [orchestrator, build]
    if: |
      needs.orchestrator.outputs.run-deploy == 'true' &&
      inputs.deploy-target != 'none'
    environment:
      name: ${{ inputs.deploy-target }}
      url: https://${{ inputs.deploy-target }}.example.com
    
    steps:
      - name: "ðŸ“¥ Descargar artifact"
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./dist
      
      - name: "ðŸ” Verificar integridad"
        run: |
          echo "ðŸ” Verificando checksum..."
          ACTUAL_SHA=$(find dist -type f -exec sha256sum {} \; | sha256sum | cut -d' ' -f1)
          EXPECTED_SHA="${{ needs.build.outputs.build-sha }}"
          
          if [ "$ACTUAL_SHA" != "$EXPECTED_SHA" ]; then
            echo "âŒ Checksum no coincide!"
            exit 1
          fi
          
          echo "âœ… Integridad verificada"
      
      - name: "ðŸš€ Deploy"
        env:
          DEPLOY_CONFIG: ${{ needs.orchestrator.outputs.deploy-config }}
        run: |
          echo "ðŸš€ Desplegando a: ${{ inputs.deploy-target }}"
          echo "ðŸ“¦ Artifact: ${{ needs.build.outputs.artifact-name }}"
          
          # Parse config
          echo "$DEPLOY_CONFIG" | jq .
          
          # Simular deployment
          STEPS=("Preparando entorno" "Subiendo archivos" "Configurando" "Reiniciando servicios" "Verificando")
          
          for step in "${STEPS[@]}"; do
            echo "  â³ $step..."
            sleep 2
            echo "  âœ… $step completado"
          done
          
          echo "âœ… Deploy exitoso"
      
      - name: "ðŸ¥ Health Check"
        run: |
          echo "ðŸ¥ Verificando salud del servicio..."
          
          URL="https://${{ inputs.deploy-target }}.example.com"
          
          # Simular health checks
          for i in {1..5}; do
            echo "  Check $i/5... OK"
            sleep 1
          done
          
          echo "âœ… Servicio saludable"
          echo "ðŸ”— URL: $URL"

  # ============================================================================
  # ðŸ” JOB 5: SECURITY AUDIT
  # ============================================================================
  security:
    name: "ðŸ” Security Audit"
    runs-on: ubuntu-latest
    needs: [orchestrator, build]
    if: inputs.demo-mode == 'complete'
    
    steps:
      - name: "ðŸ“¥ Checkout"
        uses: actions/checkout@v4
      
      - name: "ðŸ” Escanear dependencias"
        run: |
          echo "ðŸ” Escaneando dependencias por vulnerabilidades..."
          
          # Simular escaneo
          sleep 3
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ” Security Audit
          
          - âœ… No se encontraron vulnerabilidades crÃ­ticas
          - âš ï¸ 2 vulnerabilidades menores detectadas
          - â„¹ï¸ 5 dependencias pueden actualizarse
          
          ### Recomendaciones
          1. Actualizar `package-a` a v2.0.0
          2. Revisar uso de `deprecated-lib`
          EOF
          
          echo "âœ… Audit completado"
      
      - name: "ðŸ”’ Verificar secretos"
        run: |
          echo "ðŸ”’ Verificando que no hay secretos expuestos..."
          
          # Esto estÃ¡ enmascarado automÃ¡ticamente
          echo "GitHub Token presente: ${{ secrets.GITHUB_TOKEN != '' }}"
          
          echo "âœ… No hay secretos expuestos"

  # ============================================================================
  # ðŸ“Š JOB 6: REPORTE FINAL CONSOLIDADO
  # ============================================================================
  report:
    name: "ðŸ“Š Reporte Final"
    runs-on: ubuntu-latest
    needs: [orchestrator, tests, build, deploy, security]
    if: always()
    
    steps:
      - name: "ðŸ“Š Generar reporte completo"
        run: |
          # Determinar estado general
          if [ "${{ needs.tests.result }}" == "success" ] || [ "${{ needs.tests.result }}" == "skipped" ]; then
            if [ "${{ needs.build.result }}" == "success" ]; then
              OVERALL_STATUS="âœ… EXITOSO"
              STATUS_COLOR="green"
            else
              OVERALL_STATUS="âš ï¸ PARCIAL"
              STATUS_COLOR="yellow"
            fi
          else
            OVERALL_STATUS="âŒ FALLIDO"
            STATUS_COLOR="red"
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸŽ¯ Reporte Final de Demo
          
          ## Estado General
          **$OVERALL_STATUS**
          
          ## ðŸ“‹ Resultados de Jobs
          
          | Job | Estado | DuraciÃ³n |
          |-----|--------|----------|
          | Orchestrator | ${{ needs.orchestrator.result }} | - |
          | Tests | ${{ needs.tests.result }} | ~${{ inputs.demo-mode == 'quick' && '3min' || inputs.demo-mode == 'standard' && '8min' || '15min' }} |
          | Build | ${{ needs.build.result }} | ~3min |
          | Deploy | ${{ needs.deploy.result }} | ~10min |
          | Security | ${{ needs.security.result }} | ~3min |
          
          ## ðŸŽ¯ ConfiguraciÃ³n Ejecutada
          - **Modo:** `${{ inputs.demo-mode }}`
          - **Cache habilitado:** ${{ inputs.enable-cache && 'âœ…' || 'âŒ' }}
          - **Matrices habilitadas:** ${{ inputs.enable-matrix && 'âœ…' || 'âŒ' }}
          - **Deploy target:** `${{ inputs.deploy-target }}`
          - **Execution ID:** `${{ needs.orchestrator.outputs.execution-id }}`
          
          ## ðŸ“¦ Artifacts Generados
          - Build: `${{ needs.build.outputs.artifact-name }}`
          - Test Results: MÃºltiples archivos por matriz
          
          ## ðŸŽ“ Capacidades Demostradas
          
          âœ… **Compartir Datos:**
          - Job outputs entre jobs
          - Artifacts para archivos
          - GITHUB_OUTPUT para variables
          - GITHUB_STEP_SUMMARY para UI
          
          âœ… **Matrices:**
          - Matriz dinÃ¡mica generada en runtime
          - Multiple dimensiones (OS Ã— Test Type)
          - Condicionales segÃºn inputs
          
          âœ… **Cache:**
          - Cache de dependencias (pip)
          - Cache de build artifacts
          - Restore keys con fallback
          
          âœ… **Seguridad:**
          - Uso seguro de secretos
          - Enmascaramiento automÃ¡tico
          - Environments con protecciÃ³n
          - Security audit
          
          âœ… **Condicionales:**
          - Jobs condicionales segÃºn outputs
          - Steps condicionales segÃºn cache
          - EjecuciÃ³n segÃºn inputs
          
          âœ… **Strategies:**
          - fail-fast: false para ver todos los resultados
          - Multiple OS support
          - Timeout management
          
          ## ðŸ“Š MÃ©tricas
          - **Total de jobs:** 6
          - **Jobs ejecutados:** ${{ 
            (needs.orchestrator.result != 'skipped' && 1 || 0) +
            (needs.tests.result != 'skipped' && 1 || 0) +
            (needs.build.result != 'skipped' && 1 || 0) +
            (needs.deploy.result != 'skipped' && 1 || 0) +
            (needs.security.result != 'skipped' && 1 || 0) + 1
          }}
          - **Artifacts generados:** 2+
          - **Matrices ejecutadas:** ${{ inputs.enable-matrix && 'SÃ­ (multiple runs)' || 'No' }}
          
          ## ðŸ”— Referencias
          - [Ver Artifacts](#)
          - [Ver Logs Completos](#)
          - [DocumentaciÃ³n](./EJEMPLOS_AVANZADOS_README.md)
          
          ---
          
          ### ðŸŽ‰ Demo completada exitosamente!
          
          Esta demo ha mostrado el uso prÃ¡ctico de:
          - OrquestaciÃ³n de workflows
          - Matrices dinÃ¡micas
          - Cache para performance
          - Manejo seguro de secretos
          - Environments
          - Artifacts
          - Conditional execution
          - Job dependencies
          - Outputs entre jobs
          - Step summaries
          
          **Ejecutado por:** @${{ github.actor }}
          **Run ID:** ${{ github.run_id }}
          **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
      
      - name: "ðŸŽŠ CelebraciÃ³n"
        run: |
          cat << 'EOF'
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                                                               â•‘
          â•‘                  ðŸŽ‰ DEMO COMPLETADA ðŸŽ‰                        â•‘
          â•‘                                                               â•‘
          â•‘   Has visto en acciÃ³n TODAS las capacidades avanzadas        â•‘
          â•‘   de GitHub Actions en un workflow real y funcional          â•‘
          â•‘                                                               â•‘
          â•‘   âœ… Compartir datos entre jobs                              â•‘
          â•‘   âœ… Matrices dinÃ¡micas                                      â•‘
          â•‘   âœ… Cache y optimizaciÃ³n                                    â•‘
          â•‘   âœ… Seguridad y secretos                                    â•‘
          â•‘   âœ… Environments                                            â•‘
          â•‘   âœ… Artifacts                                               â•‘
          â•‘   âœ… Conditional execution                                   â•‘
          â•‘   âœ… OrquestaciÃ³n compleja                                   â•‘
          â•‘                                                               â•‘
          â•‘   ðŸ“š Ver mÃ¡s ejemplos en EJEMPLOS_AVANZADOS_README.md       â•‘
          â•‘                                                               â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          EOF
          
          echo "ðŸŽ¯ Execution ID: ${{ needs.orchestrator.outputs.execution-id }}"
          echo "ðŸ“Š Modo ejecutado: ${{ inputs.demo-mode }}"
          echo "âœ… Estado: SUCCESS"

